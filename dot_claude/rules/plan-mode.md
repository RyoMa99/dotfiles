# Plan モードの進め方

Plan モード（EnterPlanMode）に入った場合、以下の4フェーズで進める。

---

## Phase 1: 意図の明確化

調査に入る前に、ユーザーが何を達成したいかを明確にする。

- ユーザーの要求を自分の言葉で言い換え、認識が合っているか確認する
- 曖昧な点は `AskUserQuestion` で質問する（実装方針、優先度、制約など）
- 以下を明確にしてから Phase 2 に進む：
  - **ゴール**: 何を実現したいか
  - **制約**: 技術的制約、時間的制約、互換性要件
  - **スコープ**: 今回やること・やらないこと

> Phase 1 を省略しない。調査対象が明確でないまま Phase 2 に入ると、無関係なコードを読む時間が無駄になる。

---

## Phase 2: コードベース調査

Phase 1 で明確になったゴールに基づき、既存コードを調査する。

### 調査ツールの使い分け

@~/.claude/rules/code-search.md の判断フローに従う。

特に以下を積極的に活用する：

1. **Serena** - シンボル概要の把握、定義・参照の追跡
   - `get_symbols_overview`: プロジェクト構造の把握
   - `find_symbol`: 関連クラス・関数の特定
   - `find_referencing_symbols`: 影響範囲の特定
2. **grepai** - セマンティック検索で類似パターン発見（クエリは英語で）
3. **Grep / Glob** - パターンマッチによる検索

### 調査で明らかにすべきこと

- 変更が必要なファイルと影響範囲
- 既存の設計パターン・慣習
- 類似機能の既存実装（参考にできるコード）

---

## Phase 3: 計画策定

Phase 1 の意図と Phase 2 の調査結果に基づき、実装計画を作成する。

- 具体的な変更対象（ファイル・シンボル）を列挙
- タスクを依存関係に基づき順序付け
- リスクや判断が必要なポイントを明示

---

## Phase 4: 計画レビュー（自己レビュー）

Phase 3 の計画を、シニアエンジニアの視点で自己レビューする。
`ExitPlanMode` の前に必ず実施する。

### レビュー観点（優先度順）

1. **複雑性の妥当性**（最優先）
   - この要件に対してこの複雑さは妥当か？
   - より単純な解決策はないか？
   - 不要な作業を生み出していないか？

2. **保守性・一貫性**
   - 類似機能の既存実装スタイルと整合しているか
   - 命名規則・ディレクトリ構成・エラーハンドリング方針

3. **完全性**
   - 各要件を「WHEN [条件] THEN [動作]」形式で書けるか？書けないなら曖昧
   - エッジケース・エラーハンドリングの考慮

4. **リスク**
   - 破壊的変更の影響範囲
   - パフォーマンス・セキュリティ

5. **テスト戦略**
   - 検証方法が明確か

6. **段階分割**
   - タスクサイズは適切か
   - 各タスクがどの要件を満たすか追跡可能か

7. **計画内部の一貫性**
   - スコープ（Phase 1）とタスク分割のカバー範囲が一致しているか
   - 型定義・インターフェース設計と、テスト戦略で想定している型が整合しているか
   - ファイル構成が複数箇所で言及されている場合、矛盾していないか

### 過去の学びを参照

レビュー時に以下を確認し、過去の失敗を繰り返さないようにする：
- @~/.claude/rules/plan-review-learnings.md（汎用的な学び）
- `{project}/.claude/rules/plan-review.md`（プロジェクト固有、存在する場合）

### 指摘の形式

問題がある場合は **重要度 → 問題 → 理由 → 代替案** で提示する。

重要度の分類：
- **Critical**: 実装着手不可。設計の根本に関わる問題（例: スコープの矛盾、不可能な要件）
- **Major**: 実装前に解決すべき。品質やスケジュールに大きく影響（例: エッジケース未考慮）
- **Minor**: 改善推奨だが実装は可能（例: 命名の改善、テストケースの追加）

```
❌ [Critical/Major/Minor] 問題: [何が問題か]
   理由: [なぜ問題か]
   代替案: [どうすべきか]
```

### レビュー後

- 問題がなければ `ExitPlanMode` でユーザーの承認を得る
- Critical/Major があれば計画を修正し、再度レビューしてから `ExitPlanMode`
- **反復は最大3回**。3回で解消しない場合はユーザーに判断を仰ぐ
- Minor のみの場合は指摘を明記した上で `ExitPlanMode` してよい
- 重要な学びがあれば `plan-review-learnings.md` への追記を提案
