---
name: session-retrospective
description: セッション終了時の統合振り返り。4つの観点（ドメイン知識・技術的学び・自動化機会・既存知識の更新）でセッションを分析し、1回のやりとりで保存先を振り分ける。
user-invocable: true
allowed-tools: ["Bash", "Read", "Write", "Edit", "Glob", "Grep", "AskUserQuestion"]
---

# Session Retrospective

セッションの振り返りを4つの観点で構造的に行い、得られた知見を適切な保存先に振り分ける統合スキル。

## 背景

CyberAgent ジャンプTOON チームの「多観点チェックリスト」アプローチに着想を得た設計。
従来の3スキル逐次実行（`/record-business-knowledge` → `/sync-knowledge` → `/suggest-automation`）を
1回の実行に統合し、やりとりのターン数を削減する。

## When to Use This Skill

- セッション終了時（`implementation.md` Step 5）
- `/session-retrospective` コマンドを実行
- 「振り返って」「まとめて」と依頼

## 4つの観点（Perspectives）

| # | 観点 | 検出対象 | 保存先 |
|---|------|---------|--------|
| 1 | **ドメイン知識** | 業務ルール、用語、仕様理解 | `business_knowledge/` リポジトリ |
| 2 | **技術的学び** | 型設計、テスト、エラー解決パターン | `~/.claude/rules/` |
| 3 | **自動化機会** | 繰り返しパターン、定型操作 | hooks / skills / rules |
| 4 | **既存知識の更新** | 陳腐化した情報、矛盾する知見 | 該当ルールファイルを更新 |

## 実行フロー

### Step 1: セッション走査（自動）

セッション全体を振り返り、4観点それぞれで該当する知見を抽出する。

#### 走査の判断基準

各観点について、以下のシグナルが検出された場合に知見として抽出する。

**観点1: ドメイン知識**
- ユーザーが業務ルールや仕様を口頭で説明した
- 「〜という仕様」「〜というルール」「〜の場合は〜する決まり」といった発言
- コード内のビジネスロジックを理解するために背景知識が必要だった場面
- ドメイン固有の用語が登場し、定義が明らかになった

**観点2: 技術的学び**
- エラーを解決し、原因と対策が明らかになった
- ライブラリやフレームワークの挙動で「こうすべき」と分かった場面
- 設計パターンの選択で「この方が良い」と判明した
- 型定義やテスト手法で新しい知見を得た

**観点3: 自動化機会**（既存の suggest-automation シグナルを継続）
- 同じチェックを毎回手動で実行した
- 3ステップ以上の連続した操作を行った
- 「〜する前に確認して」という依頼パターンがあった
- エラー後の定型的な修正を行った

**観点4: 既存知識の更新**
- セッション中の検索（コード検索・Web検索・ドキュメント参照）で、`~/.claude/rules/` の既存記述と類似または矛盾する情報源を発見した
- 既存ルールに従ったが、うまくいかず別のアプローチが正解だった
- ライブラリのバージョンアップ等で既存の回避策が不要になった
- 既存ルールの記述が曖昧で、今回の経験でより具体的に書けるようになった

### Step 2: レポート生成

以下の形式で統合レポートを提示する。

```markdown
## セッション振り返り

### 検出した知見

#### 🏢 ドメイン知識
| # | 内容 | ドメイン | 重要度 |
|---|------|---------|--------|
| D1 | [知見の概要] | [ドメイン名] | 高/中/低 |

#### 🔧 技術的学び
| # | 内容 | カテゴリ | 保存先 |
|---|------|---------|--------|
| T1 | [学びの概要] | [型設計/テスト/etc] | [ファイル名] |

#### ⚡ 自動化機会
| # | 内容 | 種類 | 信頼度 |
|---|------|------|--------|
| A1 | [パターンの概要] | hook/skill/rule | 0.3-0.9 |

#### 🔄 既存知識の更新
| # | 対象ファイル | 更新内容 | 理由 |
|---|-------------|---------|------|
| U1 | [ファイル名] | [何を更新するか] | [なぜ更新が必要か] |

---

該当なしの観点は省略。
保存する項目を選んでください（例: D1, T1, A1 / all / none）
```

### Step 3: ユーザー承認

ユーザーが選択した項目のみを保存する。

- `all` → 全項目を保存
- `none` → 何も保存しない
- `D1, T1` → 指定した項目のみ保存
- 個別の項目について修正を求められた場合は修正してから保存

### Step 4: 振り分け実行

承認された項目を保存先に振り分ける。

| 観点 | 保存アクション |
|------|--------------|
| ドメイン知識 | `business_knowledge/` にファイル作成/追記 → コミット＆プッシュ |
| 技術的学び | `~/.claude/rules/` の該当ファイルに追記 |
| 自動化機会 | hooks: `settings.json` に追加 / skills: `~/.claude/skills/` に作成 / rules: 該当ファイルに追記 |
| 既存知識の更新 | 該当ルールファイルのセクションを更新（追記ではなく書き換え） |

### Step 5: 完了報告

```markdown
## 保存完了

| 項目 | 保存先 | ステータス |
|------|--------|----------|
| D1 | business_knowledge/xxx/notes/yyy.md | ✅ |
| T1 | ~/.claude/rules/troubleshooting.md | ✅ |
```

## 重要なルール

1. **該当なしは正常** - 全セッションで学びがあるわけではない。無理に検出しない
2. **ユーザー承認必須** - 自動保存しない
3. **既存知識の確認** - 追記前に必ず既存内容を読み、重複・矛盾を確認
4. **鮮度の意識** - 新しい知見が既存の記述と矛盾する場合、更新を提案（観点4）
5. **秘密情報除外** - APIキー、トークン、個人情報は含めない
6. **簡潔に** - 1セッションで大量の知見を無理に絞り出さない

## 保存先マッピング（技術的学び）

| カテゴリ | ファイル |
|---------|---------|
| React/Next.js | `~/.claude/rules/react-nextjs.md` |
| TypeScript | `~/.claude/rules/typescript.md` |
| テスト | `~/.claude/rules/testing.md` |
| API設計 | `~/.claude/rules/api-design.md` |
| DB | `~/.claude/rules/database.md` |
| DevOps | `~/.claude/rules/devops.md` |
| Terraform | `~/.claude/rules/terraform-guidelines.md` |
| セキュリティ | `~/.claude/rules/security.md` |
| 問題解決 | `~/.claude/rules/troubleshooting.md` |
| フロントエンド | `~/.claude/rules/web-frontend.md` |
| 命名 | `~/.claude/rules/naming.md` |
| 型設計 | `~/.claude/rules/type-granularity.md` |
| ドメインモデリング | `~/.claude/rules/domain-modeling.md` |
| プランレビュー | `~/.claude/rules/plan-review-learnings.md` |
| その他 | 新規ファイルを提案 or `~/.claude/rules/general.md` |

## 自動化機会の信頼度基準

| スコア | 条件 |
|--------|------|
| 0.9 | 3回以上の繰り返し + 明確なパターン |
| 0.7 | 2回の繰り返し or 明示的なユーザーの要望 |
| 0.5 | 1回だが一般的に有用と判断 |
| 0.3 | 仮説段階、要検証 |

## 既存スキルとの関係

このスキルは以下の3スキルの機能を統合する。
個別のスキルは引き続き単独で使用可能。

- `/record-business-knowledge` → 観点1（ドメイン知識）
- `/sync-knowledge` → 観点2（技術的学び）+ 観点4（既存知識の更新）
- `/suggest-automation` → 観点3（自動化機会）
