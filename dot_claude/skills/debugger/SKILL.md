---
name: debugger
description: 体系的なデバッグプロセスで複雑なバグを診断・解決する。根本原因分析と再発防止まで含む。
allowed-tools: ["Bash", "Glob", "Grep", "Read", "Edit", "Write", "Task"]
---

# Debugger Skill

複雑なソフトウェア問題の診断、根本原因分析、体系的な問題解決を行うスキル。

## When to Use This Skill

Trigger when user:
- `/debugger` または `/debug` コマンドを実行
- 「デバッグして」「バグを調査して」「なぜ動かないか調べて」と依頼
- エラーメッセージやスタックトレースを提示して助けを求めた時
- 「原因を特定して」「根本原因を調べて」と依頼

## 使用が適切な場面

| 場面 | 説明 |
|------|------|
| 原因不明のエラー | スタックトレースだけでは原因がわからない |
| 再現困難なバグ | 時々発生する、環境依存のバグ |
| パフォーマンス問題 | 遅い、メモリリーク、CPU高負荷 |
| 並行処理の問題 | レースコンディション、デッドロック |
| 本番環境の障害 | ログから原因を追跡する必要がある |
| 複数コンポーネント | 問題の発生箇所が不明確 |

## 7段階の診断アプローチ

```
┌─────────────────────────────────────────────────────────────┐
│  1. 症状分析      エラーメッセージ、ログ、再現条件を収集   │
│       ↓                                                     │
│  2. 仮説形成      考えられる原因を列挙                     │
│       ↓                                                     │
│  3. 体系的排除    仮説を一つずつ検証・排除                 │
│       ↓                                                     │
│  4. 証拠収集      ログ、メトリクス、コード分析             │
│       ↓                                                     │
│  5. パターン認識  類似のバグパターンと照合                 │
│       ↓                                                     │
│  6. 根本原因特定  真の原因を確定                           │
│       ↓                                                     │
│  7. 解決と検証    修正を実装し、テストで検証               │
└─────────────────────────────────────────────────────────────┘
```

## 実行フロー

### Phase 1: 問題の理解

ユーザーから以下を収集：

```markdown
## 問題の整理

**症状**: 何が起きているか
**期待動作**: 本来どうあるべきか
**再現手順**: どうすれば再現できるか
**環境**: OS、言語バージョン、依存関係
**最近の変更**: 直近で変更した箇所
**エラーメッセージ**: 完全なスタックトレース
```

不足情報があれば質問する。

### Phase 2: 仮説の形成

考えられる原因を優先度順にリスト化：

```markdown
## 仮説一覧

1. [高確率] データベース接続のタイムアウト
   - 根拠: エラーメッセージに "connection timeout" が含まれる
   - 検証方法: DB接続設定とネットワーク状況を確認

2. [中確率] 環境変数の未設定
   - 根拠: 本番環境でのみ発生
   - 検証方法: 環境変数の比較

3. [低確率] ライブラリのバージョン不整合
   - 根拠: 最近依存関係を更新した
   - 検証方法: package-lock.json の差分確認
```

### Phase 3: 体系的調査

各仮説を順番に検証：

```bash
# 1. ログの確認
grep -r "ERROR\|Exception" logs/

# 2. 環境の確認
env | grep DB_

# 3. 依存関係の確認
npm ls --depth=0
```

**重要**: 一度に1つの仮説だけを検証する。複数同時に変更しない。

### Phase 4: 根本原因の特定

調査結果をまとめ、根本原因を特定：

```markdown
## 根本原因分析

**直接原因**: DBコネクションプールの枯渇
**根本原因**: トランザクションが正しくクローズされていない
**影響範囲**: 全APIエンドポイント
**発生条件**: 同時リクエスト数が50を超えた時
```

### Phase 5: 修正と検証

```markdown
## 修正計画

1. 修正内容: finally ブロックでコネクションをクローズ
2. 影響ファイル: src/db/connection.ts
3. テスト方法: 負荷テストで同時接続100を検証
4. ロールバック: git revert で即座に戻せる
```

修正後、必ずテストで検証。

### Phase 6: 再発防止

```markdown
## 再発防止策

1. **監視追加**: コネクションプール使用率のメトリクス
2. **テスト追加**: 高負荷時のテストケース
3. **ドキュメント**: 接続管理のベストプラクティスを記載
4. **コードレビュー**: 同様のパターンがないか確認
```

---

## デバッグ技法リファレンス

### メモリ関連

| 問題 | 調査方法 |
|------|---------|
| メモリリーク | ヒープダンプ、メモリプロファイラ |
| バッファオーバーフロー | AddressSanitizer、Valgrind |
| 解放後使用 | メモリデバッガ、ログ追跡 |

### 並行処理

| 問題 | 調査方法 |
|------|---------|
| レースコンディション | ログにタイムスタンプ、Thread Sanitizer |
| デッドロック | スレッドダンプ、ロック順序分析 |
| ライブロック | 状態遷移ログ |

### パフォーマンス

| 問題 | 調査方法 |
|------|---------|
| CPU高負荷 | プロファイラ、フレームグラフ |
| I/O遅延 | システムコールトレース、待機分析 |
| N+1クエリ | クエリログ、APMツール |

### 本番環境

| 問題 | 調査方法 |
|------|---------|
| 断続的エラー | ログ集約、相関分析 |
| カスケード障害 | 分散トレーシング |
| 設定ミス | 環境差分比較 |

---

## 出力フォーマット

調査完了時は以下の形式で報告：

```markdown
## デバッグレポート

### 問題サマリー
[問題の簡潔な説明]

### 根本原因
[特定した原因]

### 修正内容
[実施した修正]

### 検証結果
[テスト結果]

### 再発防止
[追加した対策]

### 学び
[今後に活かせる知見]
```

---

## 重要な原則

1. **仮説を立ててから調査** - 闇雲にコードを読まない
2. **一度に1つの変数** - 複数同時に変更しない
3. **証拠を残す** - 調査過程を記録する
4. **再現を優先** - 再現できれば半分解決
5. **根本原因まで掘る** - 表面的な修正で終わらない
6. **再発防止まで** - 同じバグを二度起こさない
